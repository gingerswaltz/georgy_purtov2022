<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>График</title>
    <style>
      canvas {
        border: 1px solid #000;
        margin-top: 20px;
        /* Добавляем отступ сверху для второго холста */
      }
    </style>
  </head>

  <body>
    <canvas id="chartCanvas" width="600" height="400"></canvas>
    <canvas id="bChartCanvas" width="600" height="400"></canvas>
    <canvas id="photoCanvas" width="1920" height="1080"></canvas>

    <!-- Второй холст для копии фото -->
    <input type="file" id="imageInput" accept="image/*" />
    <script>
      var chartCanvas = document.getElementById("chartCanvas");
      var chartCtx = chartCanvas.getContext("2d");
      var photoCanvas = document.getElementById("photoCanvas");
      var photoCtx = photoCanvas.getContext("2d");
      var bChartCanvas = document.getElementById("bChartCanvas");
      var bChartCtx = bChartCanvas.getContext("2d");
      var data = [];
      var barWidth;
      var redCurvePoints = [];
      var blueCurvePoints = [];

      function drawChart(data, color, context) {
        context.clearRect(0, 0, context.canvas.width, context.canvas.height);
        var maxValue = Math.max.apply(null, data);
        for (var i = 0; i <= 10; i++) {
          var y =
            context.canvas.height -
            50 -
            (i / 10) * (context.canvas.height - 100);
          context.beginPath();
          context.moveTo(45, y);
          context.lineTo(50, y);
          context.stroke();
          context.fillText(((maxValue * i) / 10).toFixed(0), 20, y);
        }
        barWidth = (context.canvas.width - 100) / data.length;
        for (var i = 0; i < data.length; i++) {
          var barHeight = (data[i] / maxValue) * (context.canvas.height - 100);
          var x = 50 + i * (barWidth + 2);
          var y = context.canvas.height - 50 - barHeight;
          context.fillStyle = color;
          context.fillRect(x, y, barWidth, barHeight);
        }
      }

      function logMouseEvent(eventType, event) {
        //console.log("Событие:", eventType, "Координаты:", event.clientX, event.clientY);
      }

      function updateChartData(newData, event, context) {
        data = newData;
        console.log("Данные графика обновлены:", newData);
        drawChart(newData, context.fillStyle, context);
      }

      var isDrawingRed = false;
      var isDrawingBlue = false;

      chartCanvas.addEventListener("mousedown", function (event) {
        isDrawingRed = true;
        redCurvePoints.push({
          x: event.clientX - chartCanvas.offsetLeft,
          y: event.clientY - chartCanvas.offsetTop,
        });
        logMouseEvent("mousedown", event);
      });

      chartCanvas.addEventListener("mouseup", function (event) {
        if (isDrawingRed) {
          isDrawingRed = false;
          var newData = getUpdatedData(redCurvePoints);
          updateChartData(newData, event, chartCtx);
          redCurvePoints = [];
          applyHistogramToPhoto(newData);
          logMouseEvent("mouseup", event);
        }
      });

      chartCanvas.addEventListener("mousemove", function (event) {
        if (isDrawingRed) {
          redCurvePoints.push({
            x: event.clientX - chartCanvas.offsetLeft,
            y: event.clientY - chartCanvas.offsetTop,
          });
          drawSegment(
            redCurvePoints[redCurvePoints.length - 2],
            redCurvePoints[redCurvePoints.length - 1],
            "red",
            chartCtx
          );
        }
        logMouseEvent("mousemove", event);
      });

      bChartCanvas.addEventListener("mousedown", function (event) {
        isDrawingBlue = true;
        blueCurvePoints.push({
          x: event.clientX - bChartCanvas.offsetLeft,
          y: event.clientY - bChartCanvas.offsetTop,
        });
        logMouseEvent("mousedown", event);
      });

      bChartCanvas.addEventListener("mouseup", function (event) {
        if (isDrawingBlue) {
          isDrawingBlue = false;
          var newData = getUpdatedData(blueCurvePoints);
          updateChartData(newData, event, bChartCtx);
          blueCurvePoints = [];
          applyHistogramToPhoto(newData);
          logMouseEvent("mouseup", event);
        }
      });

      bChartCanvas.addEventListener("mousemove", function (event) {
        if (isDrawingBlue) {
          blueCurvePoints.push({
            x: event.clientX - bChartCanvas.offsetLeft,
            y: event.clientY - bChartCanvas.offsetTop,
          });
          drawSegment(
            blueCurvePoints[blueCurvePoints.length - 2],
            blueCurvePoints[blueCurvePoints.length - 1],
            "blue",
            bChartCtx
          );
        }
        logMouseEvent("mousemove", event);
      });

      function drawSegment(startPoint, endPoint, color, context) {
        if (startPoint && endPoint) {
          context.strokeStyle = color;
          context.beginPath();
          context.moveTo(startPoint.x, startPoint.y);
          context.lineTo(endPoint.x, endPoint.y);
          context.stroke();
        }
      }

      function getUpdatedData(points) {
        var newData = data.slice();
        var maxValue = Math.max.apply(null, data);
        for (var i = 0; i < points.length; i++) {
          var columnIndex = Math.floor((points[i].x - 50) / (barWidth + 2));
          var changeValue = Math.round(
            (chartCanvas.height - 50 - points[i].y) /
              ((chartCanvas.height - 100) / maxValue)
          );
          if (changeValue < 0) changeValue = 0;
          if (changeValue > maxValue) changeValue = maxValue;
          newData[columnIndex] = changeValue;
        }
        return newData;
      }

      document
        .getElementById("imageInput")
        .addEventListener("change", function (event) {
          const file = event.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
              const image = new Image();
              image.src = e.target.result;
              image.onload = function () {
                var canvas = document.createElement("canvas");
                var ctx = canvas.getContext("2d");
                canvas.width = image.width;
                canvas.height = image.height;
                ctx.drawImage(image, 0, 0);
                var pixelData = ctx.getImageData(
                  0,
                  0,
                  canvas.width,
                  canvas.height
                ).data;
                var histogramData = calculateHistogram(pixelData);
                console.log("Гистограмма цветов:", histogramData);
                updateChartData(histogramData, "change event", chartCtx);
                updateChartData(histogramData, "change event", bChartCtx); // Обновляем график синего цвета
                photoCtx.drawImage(image, 0, 0);
              };
            };
            reader.readAsDataURL(file);
          }
        });

      function calculateHistogram(pixelData) {
        const histogram = new Array(256).fill(0);
        for (let i = 0; i < pixelData.length; i += 4) {
          const red = pixelData[i];
          histogram[red]++;
        }
        return histogram;
      }

      var previousHistogramData = null;

      function applyHistogramToPhoto(histogramData) {
        if (previousHistogramData !== null) {
          var equal = true;
          for (var i = 0; i < histogramData.length; i++) {
            if (previousHistogramData[i] !== histogramData[i]) {
              equal = false;
              break;
            }
          }
          if (equal) {
            console.error("Предыдущие данные гистограммы равны текущим данным");
          }
        }
        previousHistogramData = histogramData.slice();
        var imageData = photoCtx.getImageData(
          0,
          0,
          photoCanvas.width,
          photoCanvas.height
        );
        var pixels = imageData.data;
        var numPixels = pixels.length / 4;
        var cumulativeHistogram = calculateCumulativeHistogram(histogramData);
        for (var i = 0; i < pixels.length; i += 4) {
          var red = pixels[i];
          var green = pixels[i + 1];
          var blue = pixels[i + 2];
          pixels[i] = (cumulativeHistogram[red] / numPixels) * 255;
          pixels[i + 2] = (cumulativeHistogram[blue] / numPixels) * 255;
        }
        photoCtx.putImageData(imageData, 0, 0);
        var updatedHistogramData = calculateHistogram(
          photoCtx.getImageData(0, 0, photoCanvas.width, photoCanvas.height)
            .data
        );
        console.log(
          "Данные гистограммы после применения:",
          updatedHistogramData
        );
      }

      function calculateCumulativeHistogram(histogram) {
        var cumulativeHistogram = [];
        var sum = 0;
        for (var i = 0; i < histogram.length; i++) {
          sum += histogram[i];
          cumulativeHistogram.push(sum);
        }
        return cumulativeHistogram;
      }
    </script>
  </body>
</html>
